<!-- Botão Flutuante -->
<button 
  class="floating-chat-button btn btn-primary rounded-circle shadow-lg"
  (click)="toggleChat()"
  [class.chat-open]="chatOpen()"
  title="Axis AI - Assistente Virtual">
  @if (chatOpen()) {
    <i class="bi bi-x-lg"></i>
  } @else {
    <i class="bi bi-chat-dots-fill"></i>
  }
</button>

<!-- Chat Flutuante -->
@if (chatOpen()) {
<div class="floating-chat-window shadow-lg">
  <!-- Cabeçalho -->
  <div class="chat-header bg-primary text-white d-flex align-items-center justify-content-between gap-2 p-2 p-md-3 flex-wrap">
    <div class="d-flex align-items-center gap-2">
      <div class="bg-white bg-opacity-25 rounded-circle p-2 flex-shrink-0">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
        </svg>
      </div>
      <div class="flex-shrink-0">
        <div class="fw-semibold small">Axis AI</div>
        <small class="opacity-75" style="font-size: 0.7rem;">Online</small>
      </div>
    </div>
    <!-- Seletor de Modelo -->
    <div class="d-flex align-items-center gap-1 flex-shrink-0">
      <label for="floatingModelSelect" class="small opacity-75 mb-0 d-none d-lg-block" style="font-size: 0.7rem;">Modelo:</label>
      <select 
        id="floatingModelSelect"
        class="form-select form-select-sm" 
        style="width: auto; min-width: 120px; max-width: 150px; font-size: 0.75rem;"
        [value]="selectedModel()" 
        (change)="onModelChange($any($event.target).value)"
        [disabled]="isLoadingModels() || loading()">
        @if (isLoadingModels()) {
          <option>Carregando...</option>
        } @else {
          @for (model of availableModels(); track model.name) {
            <option [value]="model.name">{{ model.displayName }}</option>
          }
        }
      </select>
    </div>
  </div>

  <!-- Área de Mensagens -->
  <div #chatContainer class="chat-messages p-3">
    @for (message of messages(); track message.id) {
    <div class="mb-3 d-flex" [class.justify-content-end]="message.type === 'user'"
      [class.justify-content-start]="message.type !== 'user'">
      @if (message.type === 'user') {
      <div class="user-bubble bg-primary text-white rounded-4 px-3 py-2 shadow-sm" style="max-width: 75%;">
        @if (message.attachment) {
        <div class="mb-2">
          @if (message.attachment.type.startsWith('image/')) {
          <img [src]="'data:' + message.attachment.type + ';base64,' + message.attachment.data" 
               [alt]="message.attachment.name"
               style="max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: contain;">
          } @else {
          <div class="d-flex align-items-center gap-2 bg-white bg-opacity-20 rounded p-2">
            <i [class]="'bi ' + getFileIcon(message.attachment.name)" style="font-size: 16px;"></i>
            <span class="small">{{ message.attachment.name }}</span>
          </div>
          }
        </div>
        }
        @if (message.content) {
        <div [innerHTML]="formatMessage(message.content)" style="font-size: 0.9rem;"></div>
        }
        <small class="d-block mt-1 opacity-75" style="font-size: 0.7rem;">
          {{ message.timestamp | date:'HH:mm' }}
        </small>
      </div>
      } @else if (message.type === 'assistant') {
      <div class="assistant-bubble bg-light rounded-4 px-3 py-2 shadow-sm border" style="max-width: 75%;">
        @if (message.loading) {
        <div class="d-flex align-items-center gap-2">
          <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
          <span class="text-muted small">{{ message.content }}</span>
        </div>
        } @else {
        <div [innerHTML]="formatMessage(message.content)" style="font-size: 0.9rem;"></div>
        <small class="d-block mt-1 text-muted" style="font-size: 0.7rem;">
          {{ message.timestamp | date:'HH:mm' }}
        </small>
        }
      </div>
      } @else if (message.type === 'system') {
      @if (message.content === 'CONFIRM_TICKET') {
      <div class="w-100">
        <div class="bg-info bg-opacity-10 border border-info rounded p-3 mb-3">
          <div class="d-flex align-items-center gap-2 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              class="text-info">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            </svg>
            <strong class="text-info small">Confirme a criação do ticket</strong>
          </div>
          @if (message.data) {
          <div class="mb-3 small">
            <div class="mb-2"><strong>Título:</strong> {{ message.data.titulo }}</div>
            <div class="mb-2"><strong>Descrição:</strong> {{ message.data.descricao }}</div>
            <div class="mb-2"><strong>Prioridade:</strong>
              <span [class]="message.data.prioridade === 'Alta' ? 'badge bg-danger' : message.data.prioridade === 'Média' ? 'badge bg-warning' : 'badge bg-info'">
                {{ message.data.prioridade }}
              </span>
            </div>
            <div><strong>Categoria:</strong>
              <span class="badge bg-secondary">{{ message.data.categoria }}</span>
            </div>
          </div>
          }
          <div class="d-flex gap-2">
            <button (click)="confirmTicketCreation(message.data)" class="btn btn-primary btn-sm flex-fill">
              <i class="bi bi-check-lg me-1"></i>
              Criar Ticket
            </button>
            <button (click)="cancelTicketCreation()" class="btn btn-outline-secondary btn-sm flex-fill">
              <i class="bi bi-x-lg me-1"></i>
              Cancelar
            </button>
          </div>
        </div>
      </div>
      } @else {
      <div class="w-100 text-center">
        <div class="bg-light rounded px-3 py-2 d-inline-block">
          <small class="text-muted">{{ message.content }}</small>
        </div>
      </div>
      }
      }
    </div>
    }
  </div>

  <!-- Área de Input -->
  <div class="chat-input-area bg-white border-top p-2">
    <!-- Preview do arquivo -->
    @if (selectedFile()) {
    <div class="mb-2 p-2 bg-light rounded d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        @if (filePreview()) {
        <img [src]="filePreview()" alt="Preview" style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;">
        } @else {
        <i [class]="'bi ' + getFileIcon(selectedFile()!.name)" style="font-size: 18px; color: #0d6efd;"></i>
        }
        <div>
          <small class="d-block fw-semibold">{{ selectedFile()!.name }}</small>
          <small class="text-muted">{{ (selectedFile()!.size / 1024).toFixed(1) }} KB</small>
        </div>
      </div>
      <button type="button" class="btn btn-sm btn-link text-danger p-0" (click)="clearFile()" title="Remover anexo">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    }
    
    <div class="input-group">
      <label for="floatingFileInput" class="btn btn-outline-secondary border-0 btn-sm" style="cursor: pointer;" title="Anexar arquivo">
        <i class="bi bi-paperclip"></i>
      </label>
      <input 
        id="floatingFileInput"
        type="file" 
        class="d-none" 
        accept="image/*,application/pdf"
        (change)="onFileSelected($event)"
        [disabled]="loading()">
      <input #messageInput type="text" class="form-control border-0" placeholder="Descreva seu problema..."
        [value]="currentMessage()" (input)="currentMessage.set($any($event.target).value)"
        (keypress)="onKeyPress($event)" [disabled]="loading()">
      <button class="btn btn-primary btn-sm" type="button" (click)="sendMessage()" [disabled]="loading() || (!currentMessage().trim() && !selectedFile())">
        @if (loading()) {
        <span class="spinner-border spinner-border-sm" role="status"></span>
        } @else {
        <i class="bi bi-send-fill"></i>
        }
      </button>
    </div>
  </div>
</div>
}
